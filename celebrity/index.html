<!DOCTYPE html>
<html>
<head>
    <script src="http://code.jquery.com/jquery-1.11.3.min.js"></script>
    <script src="http://code.jquery.com/jquery-migrate-1.2.1.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/js-url/2.0.2/url.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react/0.13.3/react.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react/0.13.3/JSXTransformer.js"></script>
    <link href='https://fonts.googleapis.com/css?family=Open+Sans:400,600,700' rel='stylesheet' type='text/css'>
    <link rel="stylesheet" type="text/css" href="./font-awesome-4.3.0/css/font-awesome.min.css">
    <link rel="stylesheet" type="text/css" href="./layout.css">
    <link rel="stylesheet" type="text/css" href="./celebrity-query-form.css">
    <link rel="stylesheet" type="text/css" href="//cdn.jsdelivr.net/jquery.slick/1.5.7/slick.css"/>
    <script type="text/javascript" src="//cdn.jsdelivr.net/jquery.slick/1.5.7/slick.min.js"></script>
    <title>Celebrities</title>
</head>
<body>
    <div class="main front">
        <div class="navbar post-row">
            <form id="celebrity-query-form" class="cell-container max-600">
                <input type="text" id="celebrity-query-form__height"></input>
                <button type="submit" id="celebrity-query-form__submit">Check!</button>
            </form>
        </div>
        <div id="content"></div>
</body>
</html>

<script type="text/jsx">
    var Container = React.createClass({
        render: function() {
            return (
                <div className="c-content">
                    <CelebrityList data={this.props.data} />
                </div>
            );
        }
    });

    var CelebrityList = React.createClass({
        render: function() {
            var celebrityNodes = this.props.data.map(function (celebrity) {
                return (
                    <div className="post-row">
                        <div className="cell-container max-600">
                            <div className="celebrity-name">{celebrity.name}</div>
                            <div className="celebrity-height">{celebrity['/people/person/height_meters']}</div>
                        </div>
                        <div className="cell-container max-600">
                            <CelebrityImage data={celebrity['/common/topic/image']} />
                        </div>
                    </div>
                );
            });
            return (
                <div>
                    {celebrityNodes}
                </div>
            );
        }
    });

    var CelebrityImage = React.createClass({
        render: function() {
            var key = "AIzaSyCQVC9yA72POMg2VjiQhSJQQP1nf3ToZTs";
            var imgDomain = 'https://usercontent.googleapis.com/freebase/v1/image';
            var pictureNodes = this.props.data.map(function (picture, i, arr) {
                var pictureSource = "url(" + imgDomain + picture.id + '?key=' + key + "&maxwidth=300)";

                var divStyle = {
                    backgroundImage: pictureSource,
                    backgroundSize: "cover"
                };
                return (
                    <div className="cell cell-33">
                        <div className="post small" style={divStyle}></div>
                    </div>
                );
            });
            return (
                <div>
                    {pictureNodes}
                </div>
            );
        }
    });

    var data = [];

    function queryCelebrities(params) {
        params = params || {};

        var service_url = 'https://www.googleapis.com/freebase/v1/mqlread';

        var query = [{
            'limit': parseInt(url('?limit') || "100"),
            'id': null,
            'name': null,
            'type': '/celebrities/celebrity',
            '/people/person/height_meters': parseFloat(params.height || url('?height') || "1.69"),
            '/common/topic/image': [{
                'id': null,
                'limit': parseInt(url('?imgLimit') || "3")
            }]
        }];

        $.getJSON(service_url + '?callback=?', {query:JSON.stringify(query)}, function(response) {
            React.render(
                <Container data={response.result}/>,
                document.getElementById('content')
            );
        });
    }

    queryCelebrities();

    $("#celebrity-query-form").submit(function(event) {
        event.preventDefault();

        queryCelebrities({
            height: parseFloat($("#celebrity-query-form__height").val())
        })
    })
</script>

